<?xml version="1.0" encoding="UTF-8"?>
<story newline="print">
  <print>Monster battle!</print>

  <dice name="d6" sides="6" />
  <dice name="d3" sides="3" />

  <!--
  <input name="nr" label="Choose players (1-2): " validation="[1-2]"/>
  -->

  <input name="name" label="Name of player: " />

  <!-- TODO: Equipment -->
  <list name="players">
    <record name="player1">
      <name>{name}</name>
      <attack>{%d6 + %d6}</attack>
      <hitpoints>{%d6 + %d6}</hitpoints>
    </record>
  </list>

  <print>--- Player stats ---</print>
  <print>Name: {player1.name}</print>
  <print>Attack: {player1.attack}</print>
  <print>Hit-points: {player1.hitpoints}</print>
  <br/>

  <!-- Assumes list item "player" is set -->
  <!-- Assumes list item "monster" is set -->
  <!-- Assumes variable "path" is set to 0 -->
  <variable name="path" value="0" />
  <clear type="flag" name="endbattle" ignore-not-found="1" />
  <graph name="player_attack" start="0">
    <node id="0" connections="{path}">
      <print>1. Attack</print>
      <print>2. Flee</print>
      <input name="path" label="Choose your action, player {player.name} (1-2): " validation="[1-2]"/>
    </node>
    <node id="1" connections="0">
      <!-- Player attacks the monster -->
      <print>{player.name} attacks! {player.attack} damage to {monster.name}.</print>
      <set record="monster" field="hitpoints" value="{monster.hitpoints - player.attack}" />
      <print>Hitpoints left: {monster.hitpoints}</print>
    </node>
    <node id="2" connections="0">
      <print>Player flees!</print>
    </node>
  </graph>

  <!-- Battle flow -->
  <graph name="battle" start="0">
    <node id="0" connections="1">/start/</node>
    <node id="1" connections="2">
      <loop list="players" record="player">
        <print>Player {player.name} attacks</print>
        <!-- Always reset path to 0 before starting player attack graph. -->
        <set variable="path" value="0" />
        <print>{@player_attack}</print>
        <print>{@player_attack}</print>
        <if content="{monster.hitpoints}" lessThan="0">
          <print>The monster is defeated</print>
          <setFlag name="endbattle" />
        </if>
      </loop>
      <print>The monster attacks back</print>
    </node>
    <node id="2" connections="1">
      <print>Monsters attack</print>
    </node>
  </graph>

  <!-- Dungone flow -->
  <graph name="dungeon" start="1">
    <node id="1" connections="2">/start/</node>
    <node id="2" connections="2">
      <print>Welcome to the dungeon! Please respect the rules.</print>
    </node>
    <node id="3" connections="3">
      <print>Room</print>
      <loop until="endbattle">
        <print>{@battle}</print>
      </loop>
    </node>
  </graph>

  <record name="monster">
    <name>Tiny troll</name>
    <attack>2</attack>
    <hitpoints>{%d3}</hitpoints>
  </record>

  <print>{@battle}</print>
</story>
