<?xml version="1.0" encoding="UTF-8"?>
<story newline="print">
  <print>Monster battle!</print>

  <dice name="d6" sides="6" />
  <dice name="d3" sides="3" />

  <input name="name" label="Name of player: " validation="[a-zA-Z]+" />

  <!-- Randomize player statistics -->
  <record name="player">
    <name>{name}</name>
    <attack>{%d6 + %d6}</attack>
    <hitpoints>{%d6 + %d6}</hitpoints>
  </record>

  <!-- Indirection -->
  <macro name="attackroll">
    <alt>{%d6}</alt>
  </macro>

  <deck name="monsterdeck">
    <record name="monster">
      <name>tiny troll</name>
      <attack>{%d3}</attack>
      <hitpoints>{%d6 + %d6}</hitpoints>
    </record>
  </deck>

  <print>--- Player stats ---</print>
  <print>Name: {player.name}</print>
  <print>Attack: {player.attack}</print>
  <print>Hit-points: {player.hitpoints}</print>

  <!-- Attack flow -->
  <!-- Assumes record "player" is set -->
  <!-- Assumes record "monster" is set -->
  <!-- Assumes variable "path" is set to 0 -->
  <variable name="path" value="0" />
  <clear type="flag" name="endbattle" ignore-not-found="1" />
  <graph name="player_attack" start="0">
    <node id="0" connections="{path}">
      <print>1. Attack</print>
      <print>2. Flee</print>
      <input name="path" label="Choose your action (1-2): " validation="^[1-2]$"/>
    </node>
    <node id="1" connections="0">
      <!-- Player attacks the monster -->
      <print>{player.name} attacks! {player.attack} damage to {monster.name}.</print>
      <set record="monster" field="hitpoints" value="{monster.hitpoints - player.attack}" />
      <print>Hitpoints left: {monster.hitpoints}</print>
    </node>
    <node id="2" connections="0">
      <print>Player flees!</print>
      <setFlag name="endbattle" />
    </node>
  </graph>

  <!-- Battle flow -->
  <graph name="battle" start="0">
    <node id="0" connections="1">/start/</node>
    <node id="1" connections="2">
        <print>Player {player.name} attacks</print>
        <!-- Always reset path to 0 before starting player attack graph. -->
        <set variable="path" value="0" />
        <print>{@player_attack}</print>
        <print>{@player_attack}</print>
        <if content="{monster.hitpoints}" lessThan="1">
          <print>The monster is defeated</print>
          <setFlag name="endbattle" />
        </if>
    </node>
    <node id="2" connections="1">
      <print>The monster attacks back</print>
      <set record="player" field="hitpoints" value="{player.hitpoints - monster.attack}" />
      <print>Player has {player.hitpoints} hitpoints left</print>
      <if content="{player.hitpoints}" lessThan="1">
        <print>Player DED</print>
        <setFlag name="endbattle" />
      </if>
    </node>
  </graph>

  <!-- Dungone flow -->
  <graph name="dungeon" start="0">
    <node id="0" connections="1">/start/</node>
    <node id="1" connections="2">
      <print>Welcome to the dungeon! Please respect the rules.</print>
    </node>
    <node id="2" connections="2,3">
      <print>Corridor leading south</print>
    </node>
    <node id="3" connections="2">
      <print>Room with monster - prepare for battle!</print>
      <print>{$monsterdeck}You meet a {monster.name}.</print>
      <loop until="endbattle">
        <print>{@battle}</print>
      </loop>
    </node>
  </graph>

  <loop times="5">
    <print>{@dungeon}</print>
    <sleep time="1"/>
  </loop>
</story>
